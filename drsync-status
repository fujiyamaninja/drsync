#!/usr/bin/env bash

username="$USER"

while getopts 'u:h' opt; do
  case "$opt" in
    u)
      username="$OPTARG"
      ;;

    ?|h)
      echo "Usage: $(basename $0) [-u username]"
      exit 1
      ;;
  esac
done
shift "$(($OPTIND -1))"

if [ $# -eq 0 ]
  then
    num=3
  else
    num="$1"
fi

transfer_num_latest=`ls "$HOME/.drsync_transfers" | sort --version-sort | grep "drsync.*.cmd" | tail -1 | grep -o "[1-9][0-9]*"`
session_name=`printf 'drsync.%06g' "$transfer_num"`

if (( num > transfer_num_latest )); then
  num="$transfer_num_latest"
fi

for ((n=num-1;n>-1;n--))
do
  log_num=$((transfer_num_latest - n))
  session_name=`printf 'drsync.%06g' "$log_num"`
  logfile=$(eval echo ~"$username"/.drsync_transfers/"$session_name".status)
  if [ -f "$logfile" ]; then
    echo "========> $logfile <========"
    sed -e '/^$/d' "$logfile"
    echo ''
  fi
done
